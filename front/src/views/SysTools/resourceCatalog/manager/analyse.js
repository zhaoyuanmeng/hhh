import Polygon3D from './polygon3d.class.js'

class AnalyseBIZ extends Polygon3D {
    constructor() {
        super()

        // 绿地
        this.greenData = {
            camera: [492484.46875, 2491890.25, 962.949585, -77.237495, -73.664597],
            data: [
                {
                    id: 'greenanalyse0',
                    coordinates: [
                        [492241.21875, 2492405, 2.213163],
                        [492319.3125, 2492366.75, 2.115742],
                        [492382.34375, 2492342.75, 2.213282],
                        [492445.71875, 2492318.75, 2.213282],
                        [492543.21875, 2492295.25, 2.213242],
                        [492796.5625, 2492268.5, 2.213282],
                        [492802.375, 2492265.25, 2.213282],
                        [492797.15625, 2492247.25, 2.213282],
                        [492765.09375, 2492162.75, 2.115742],
                        [492687.84375, 2491995, 2.123203],
                        [492652.09375, 2491972.75, 2.213282],
                        [492598.78125, 2491966.75, 2.213242],
                        [492425.09375, 2492014.25, 2.213282],
                        [492296.59375, 2492052.25, 2.213242],
                        [492275.09375, 2492077, 2.213282],
                        [492261.09375, 2492120.25, 2.21332],
                        [492240.03125, 2492231.25, 2.213282],
                        [492231.0625, 2492359.25, 2.213282]
                    ],
                }
            ]
        }
        // 红线
        this.redLineData = {
            camera: [492126.875, 2491961.75, 307.769714, -48.95063, -27.402342],
            data: [
                {
                    id: 'redline0',
                    height: 98,
                    color: [1, 0, 0, 1],
                    coordinates: [
                        [492271.75, 2492130.25, 2.16],
                        [492274.41, 2492122.00, 2.26],
                        [492280.66, 2492123.00, 2.26],
                        [492282.50, 2492118.00, 2.26],
                        [492277.19, 2492115.00, 2.26],
                        [492280.72, 2492106.75, 2.26],
                        [492287.41, 2492108.00, 2.16],
                        [492288.88, 2492104.75, 2.16],
                        [492282.84, 2492101.75, 2.26],
                        [492286.09, 2492092.00, 2.26],
                        [492292.50, 2492094.25, 2.26],
                        [492294.75, 2492089.00, 2.26],
                        [492289.84, 2492087.50, 2.26],
                        [492292.31, 2492077.00, 2.26],
                        [492300.13, 2492079.75, 2.26],
                        [492302.44, 2492076.25, 2.26],
                        [492296.81, 2492072.25, 2.26],
                        [492302.97, 2492063.25, 2.26],
                        [492307.13, 2492066.25, 2.26],
                        [492310.25, 2492062.25, 2.26],
                        [492305.38, 2492059.75, 2.26],
                        [492311.88, 2492050.50, 2.26],
                        [492313.34, 2492050.25, 2.21],
                        [492320.19, 2492052.50, 2.26],
                        [492325.91, 2492056.00, 2.26],
                        [492329.56, 2492057.00, 2.26],
                        [492330.13, 2492059.50, 2.16],
                        [492327.09, 2492065.50, 2.16],
                        [492326.16, 2492067.00, 2.26],
                        [492334.13, 2492072.25, 2.26],
                        [492326.09, 2492086.75, 2.26],
                        [492318.31, 2492082.00, 2.26],
                        [492313.25, 2492090.75, 2.26],
                        [492320.25, 2492094.75, 2.26],
                        [492312.88, 2492109.75, 2.26],
                        [492304.16, 2492106.50, 2.26],
                        [492298.88, 2492118.25, 2.26],
                        [492307.69, 2492121.75, 2.26],
                        [492302.03, 2492136.00, 2.16],
                        [492293.31, 2492133.50, 2.16],
                        [492290.03, 2492140.25, 2.16],
                        [492286.75, 2492141.75, 2.16],
                        [492283.94, 2492139.00, 2.16],
                        [492278.09, 2492136.75, 2.16],
                        [492278.84, 2492133.25, 2.16],
                        [492271.72, 2492130.50, 2.26],
                    ]
                },
                {
                    id: 'redline1',
                    height: 84,
                    color: [0, 1, 1, 1],
                    coordinates: [
                        [492394.50, 2492049.50, 2.26],
                        [492402.75, 2492046.50, 2.26],
                        [492400.78, 2492037.75, 2.26],
                        [492415.72, 2492033.75, 2.26],
                        [492418.22, 2492042.75, 2.26],
                        [492431.75, 2492039.00, 2.26],
                        [492429.59, 2492030.25, 2.26],
                        [492444.44, 2492025.50, 2.26],
                        [492447.19, 2492034.50, 2.26],
                        [492459.56, 2492031.50, 2.26],
                        [492457.31, 2492022.00, 2.26],
                        [492472.78, 2492018.00, 2.26],
                        [492475.59, 2492027.25, 2.26],
                        [492484.59, 2492024.75, 2.26],
                        [492486.81, 2492028.75, 2.26],
                        [492485.22, 2492031.75, 2.26],
                        [492486.50, 2492038.00, 2.26],
                        [492483.44, 2492038.75, 2.26],
                        [492485.06, 2492045.75, 2.26],
                        [492476.13, 2492048.75, 2.26],
                        [492474.25, 2492043.75, 2.26],
                        [492468.97, 2492045.25, 2.26],
                        [492469.75, 2492050.00, 2.26],
                        [492460.75, 2492052.75, 2.26],
                        [492458.66, 2492046.25, 2.26],
                        [492455.41, 2492047.00, 2.26],
                        [492456.84, 2492053.25, 2.26],
                        [492447.81, 2492056.25, 2.26],
                        [492446.16, 2492051.00, 2.26],
                        [492439.94, 2492052.50, 2.26],
                        [492441.19, 2492057.75, 2.26],
                        [492432.50, 2492060.25, 2.26],
                        [492430.38, 2492053.25, 2.26],
                        [492426.59, 2492054.50, 2.26],
                        [492428.81, 2492061.75, 2.26],
                        [492419.03, 2492064.50, 2.26],
                        [492417.41, 2492058.75, 2.26],
                        [492411.47, 2492060.00, 2.26],
                        [492413.50, 2492065.25, 2.26],
                        [492403.31, 2492068.25, 2.26],
                        [492401.09, 2492061.75, 2.26],
                        [492398.53, 2492062.00, 2.26],
                        [492396.19, 2492055.50, 2.26],
                        [492393.69, 2492052.75, 2.26],
                        [492394.50, 2492049.50, 2.26],
                    ]
                },
                {
                    id: 'redline2',
                    height: 84,
                    color: [0, 1, 1, 1],
                    coordinates: [
                        [492272.69, 2492297.50, 19.261654],
                        [492271.78, 2492288.00, 19.261669],
                        [492262.78, 2492288.00, 19.261665],
                        [492262.94, 2492272.00, 19.261665],
                        [492270.78, 2492271.00, 19.261654],
                        [492271.00, 2492259.25, 19.785933],
                        [492263.1875, 2492258.75, 19.26166],
                        [492261.75, 2492242, 19.261669],
                        [492272.59375, 2492242, 19.261665],
                        [492270.94, 2492230.00, 19.26165],
                        [492262.5625, 2492230.25, 19.26166],
                        [492263.09375, 2492213, 19.26166],
                        [492272.78125, 2492213, 19.261654],
                        [492273.1875, 2492203, 19.261665],
                        [492278.1875, 2492203.25, 19.261641],
                        [492278.34375, 2492204.75, 19.261669],
                        [492285.375, 2492205, 19.26166],
                        [492285.71875, 2492208.25, 19.261669],
                        [492293.34375, 2492208.25, 19.26166],
                        [492293.34375, 2492217.5, 19.26166],
                        [492288.5, 2492218.25, 19.26165],
                        [492288.28125, 2492222, 19.26166],
                        [492293.34375, 2492222.25, 19.261669],
                        [492294.0625, 2492233.75, 19.261669],
                        [492288.375, 2492234.5, 19.261654],
                        [492288.34375, 2492237, 19.26166],
                        [492293.90625, 2492237.5, 19.26165],
                        [492293.84375, 2492247.25, 19.26166],
                        [492287.9375, 2492247.5, 19.261658],
                        [492287.9375, 2492253, 19.26166],
                        [492293.75, 2492253.75, 19.26166],
                        [492293.4375, 2492263.25, 19.261669],
                        [492287.4375, 2492263.25, 19.261654],
                        [492287.375, 2492267, 19.261654],
                        [492293.59375, 2492267.25, 19.26166],
                        [492293.1875, 2492276.5, 19.261658],
                        [492288.78125, 2492277.25, 19.261658],
                        [492288.71875, 2492282.5, 19.261658],
                        [492293.5, 2492282.75, 19.26166],
                        [492292.65625, 2492292.5, 19.261658],
                        [492286.0625, 2492293, 19.261658],
                        [492286.15625, 2492296, 19.261658],
                        [492279.00, 2492296.25, 19.261654],
                        [492278.16, 2492297.00, 19.26166],
                        [492275.72, 2492297.75, 19.26166],
                        [492272.69, 2492297.50, 19.261654],

                    ]
                }
            ]
        }

        // 控高
        this.heightControlData = {
            camera: [492126.875, 2491961.75, 307.769714, -48.95063, -27.402342],
            data: [
                {
                    id: 'heightcontrol0',
                    height: 98,
                    top: 60,
                    color: [1, 1, 0, 0.3],
                    color_alm: [1, 0, 0, 0.3],
                    coordinates: [[492272.78125, 2492130.5, 2.15979], [492275.4375, 2492122.25, 2.261654], [492279.9375, 2492123.5, 2.26166], [492282.5, 2492117.5, 2.261669], [492278, 2492115.75, 2.261665], [492281.09375, 2492106.75, 2.26166], [492287.0625, 2492109.25, 2.261669], [492289.21875, 2492104.25, 2.261665], [492283.46875, 2492101.5, 2.261654], [492287.3125, 2492093, 2.261665], [492291.9375, 2492095.25, 2.26165], [492294.5625, 2492089.75, 2.261665], [492289.78125, 2492087.25, 2.261669], [492293.78125, 2492078, 2.26166], [492299.90625, 2492081.5, 2.26166], [492302.625, 2492076.5, 2.261665], [492297.0625, 2492072.5, 2.261665], [492302.59375, 2492064, 2.261654], [492307.15625, 2492067, 2.26166], [492310.5, 2492062.75, 2.26166], [492306.4375, 2492059.75, 2.261665], [492312.21875, 2492051, 2.213169], [492318.1875, 2492054.75, 2.26166], [492320.3125, 2492052.25, 2.26166], [492331.15625, 2492058.75, 2.159781], [492326.71875, 2492066.75, 2.26166], [492333.75, 2492072, 2.261665], [492324.5625, 2492086.25, 2.26166], [492316, 2492082, 2.26166], [492311.21875, 2492091.25, 2.261669], [492319.4375, 2492095.75, 2.261669], [492312.71875, 2492110.25, 2.261669], [492305.3125, 2492106.75, 2.26166], [492300.15625, 2492117.5, 2.26166], [492308.5625, 2492121, 2.26165], [492302, 2492137.25, 2.159784], [492294.375, 2492133.75, 2.159794], [492290.5, 2492142.75, 2.261679], [492285.28125, 2492141.25, 2.159794], [492285.4375, 2492139.5, 2.159784], [492277.46875, 2492137, 2.159781], [492278.71875, 2492133.5, 2.159781], [492272.78125, 2492130.5, 2.15979]],
                },
                {
                    id: 'heightcontrol1',
                    height: 84,
                    top: 0,
                    color: [1, 1, 0, 0.3],
                    color_alm: [1, 0, 0, 0.3],
                    coordinates: [[492393.5, 2492035.25, 2.26166], [492407.5, 2492031, 2.261654], [492409.9375, 2492040, 2.261654], [492423.9375, 2492036.25, 2.261665], [492421.65625, 2492028, 2.261665], [492436, 2492023.5, 2.26166], [492438.5, 2492032.5, 2.261665], [492451.375, 2492029, 2.261654], [492450.5, 2492019.5, 2.26166], [492464.9375, 2492015.5, 2.26166], [492466.9375, 2492024.5, 2.261654], [492468.375, 2492024.25, 2.261665], [492469.375, 2492025.25, 2.26165], [492475.03125, 2492023.5, 2.261658], [492476.28125, 2492024.25, 2.261662], [492477.15625, 2492025, 2.26166], [492477.65625, 2492025.75, 2.261658], [492477.59375, 2492026.75, 2.261662], [492476.875, 2492028, 2.261662], [492476.375, 2492028.5, 2.261662], [492477.90625, 2492034.25, 2.261658], [492477.78125, 2492034.5, 2.26166], [492475.46875, 2492035.5, 2.261662], [492477.15625, 2492042.75, 2.261662], [492469, 2492045.25, 2.261658], [492467.71875, 2492040, 2.26166], [492460.90625, 2492041.75, 2.261662], [492462.3125, 2492047, 2.261658], [492453.28125, 2492049.25, 2.26166], [492451.3125, 2492042.25, 2.261658], [492447.375, 2492043.5, 2.26166], [492448.65625, 2492050.25, 2.26166], [492440.28125, 2492052.5, 2.261662], [492438.84375, 2492047.5, 2.261662], [492433.15625, 2492049, 2.26166], [492434.21875, 2492054.75, 2.26166], [492424.5625, 2492057, 2.26166], [492423.09375, 2492050.75, 2.261662], [492418.65625, 2492051.75, 2.261665], [492420.09375, 2492058.25, 2.261662], [492411.75, 2492060.5, 2.261662], [492410.875, 2492055.25, 2.26166], [492404.15625, 2492057, 2.261665], [492405.9375, 2492062.75, 2.26166], [492395.5625, 2492065.5, 2.261665], [492394.75, 2492058.75, 2.26166], [492391.5625, 2492059.75, 2.261665], [492388.90625, 2492052, 2.261665], [492387, 2492050.5, 2.26166], [492387.15625, 2492048.75, 2.26166], [492387.84375, 2492047.25, 2.261654], [492395.59375, 2492044.5, 2.26166], [492394, 2492038.5, 2.26166], [492393.5, 2492035.25, 2.26166]]
                },
                {
                    id: 'heightcontrol2',
                    height: 84,
                    top: 0,
                    color: [1, 1, 0, 0.3],
                    color_alm: [1, 0, 0, 0.3],
                    coordinates: [[492273.75, 2492296.5, 2.261654], [492272.46875, 2492287.25, 2.261669], [492263.84375, 2492287.5, 2.261665], [492262.71875, 2492272.5, 2.261665], [492272.34375, 2492272, 2.261654], [492273.4375, 2492259, 2.785933], [492263.1875, 2492258.75, 2.26166], [492261.75, 2492242, 2.261669], [492272.59375, 2492242, 2.261665], [492273.625, 2492231.25, 2.26165], [492262.5625, 2492230.25, 2.26166], [492263.09375, 2492213, 2.26166], [492272.78125, 2492213, 2.261654], [492273.1875, 2492203, 2.261665], [492278.1875, 2492203.25, 2.261641], [492278.34375, 2492204.75, 2.261669], [492285.375, 2492205, 2.26166], [492285.71875, 2492208.25, 2.261669], [492293.34375, 2492208.25, 2.26166], [492293.34375, 2492217.5, 2.26166], [492288.5, 2492218.25, 2.26165], [492288.28125, 2492222, 2.26166], [492293.34375, 2492222.25, 2.261669], [492294.0625, 2492233.75, 2.261669], [492288.375, 2492234.5, 2.261654], [492288.34375, 2492237, 2.26166], [492293.90625, 2492237.5, 2.26165], [492293.84375, 2492247.25, 2.26166], [492287.9375, 2492247.5, 2.261658], [492287.9375, 2492253, 2.26166], [492293.75, 2492253.75, 2.26166], [492293.4375, 2492263.25, 2.261669], [492287.4375, 2492263.25, 2.261654], [492287.375, 2492267, 2.261654], [492293.59375, 2492267.25, 2.26166], [492293.1875, 2492276.5, 2.261658], [492288.78125, 2492277.25, 2.261658], [492288.71875, 2492282.5, 2.261658], [492293.5, 2492282.75, 2.26166], [492292.65625, 2492292.5, 2.261658], [492286.0625, 2492293, 2.261658], [492286.15625, 2492296, 2.261658], [492279.375, 2492296, 2.261654], [492278.28125, 2492297, 2.26166], [492273.75, 2492296.5, 2.261654]]
                }
            ]
        }
        // 剖切
        this.clipData = {
            coordinates: [[492241.21875, 2492405, 19.213163], [492319.3125, 2492366.75, 19.115742], [492382.34375, 2492342.75, 19.213282], [492445.71875, 2492318.75, 19.213282], [492543.21875, 2492295.25, 19.213242], [492796.5625, 2492268.5, 19.213282], [492802.375, 2492265.25, 19.213282], [492797.15625, 2492247.25, 19.213282], [492765.09375, 2492162.75, 19.115742], [492687.84375, 2491995, 19.123203], [492652.09375, 2491972.75, 19.213282], [492598.78125, 2491966.75, 19.213242], [492425.09375, 2492014.25, 19.213282], [492296.59375, 2492052.25, 19.213242], [492275.09375, 2492077, 19.213282], [492261.09375, 2492120.25, 19.21332], [492240.03125, 2492231.25, 19.213282], [492231.0625, 2492359.25, 19.213282]]
        }

    }
}

/**
 * 绿地分析
 */
AnalyseBIZ.prototype.startGreenbelt = function () {
    let that = this
    return new Promise(async (resolve, reject) => {
        await window.sealAPI._camera.set(...that.greenData.camera)
        var option = { // 体
            style: 1, // 样式 0-8
            coordinates: [],
            color: [0, 1, 1, 0.3],
            height: 20,
            intensity: 4.0, // 亮度
            tillingX: 5, // 贴图重复度
            tillingY: 5, // 贴图重复度
        }
        let curOa = [];
        (that.greenData.data || []).forEach(item => {
            var o = new Polygon3DData(item.id, option.style, item.coordinates, option.color, option.height, option.intensity, option.tillingX, option.tillingY)
            o.utype = 'polygon3d'
            curOa.push(o)
        })

        await that.add(curOa)
        resolve({ success: 1 })
    })
}

/**
 * 红线分析
 */
AnalyseBIZ.prototype.startRedLine = function () {
    let that = this
    return new Promise(async (resolve, reject) => {
        await window.sealAPI._camera.set(...that.redLineData.camera)
        let option = {
            groupId: 'redThread',
            style: 5, // 折线样式
            thickness: 1, // 线宽
            intensity: 0.3, // 亮度
            flowRate: 0.1, // 流速
            tiling: 0, // 材质贴图平铺比例
            depthTest: false, // 是否做深度检测，true会被遮挡，false不会被遮挡
            shape: 0, // 样式，0：直线， 1：曲线
        }
        let curOa = [];
        (that.redLineData.data || []).forEach(item => {
            curOa.push({
                id: item.id,
                color: item.color,
                coordinates: item.coordinates, // 坐标点数组
                ...option
            })
        })
        await window.sealAPI._polyline.add(curOa)
        resolve({ success: 1 })
    })
}

/**
 * 控高分析
 */
AnalyseBIZ.prototype.startHeightControl = function () {
    let that = this
    return new Promise(async (resolve, reject) => {
        await window.sealAPI._camera.set(...that.heightControlData.camera)
        let option = {
            style: 1, // 3DPolygon的样式
            intensity: 1, // 亮度
            tillingX: 5, // 设置贴图横向平铺
            tillingY: 5, // 设置贴图纵向平铺
        }
        let curOa = [];
        (that.heightControlData.data || []).forEach(item => {
            if (item.top > 0) {
                let newCoors = []
                newCoors = item.coordinates
                curOa.push({
                    id: item.id,
                    coordinates: item.coordinates, // 多边形坐标数组
                    color: item.color,
                    height: item.top, // 3D多边形的高度
                    ...option
                })

                let newCoors2 = [];
                (item.coordinates || []).forEach(jtem => {
                    newCoors2.push([
                        jtem[0],
                        jtem[1],
                        jtem[2] + item.top
                    ])
                })
                curOa.push({
                    id: `${item.id}1`,
                    coordinates: newCoors2, // 多边形坐标数组
                    color: item.color_alm,
                    height: item.height - item.top, // 3D多边形的高度
                    ...option
                })

            } else {
                curOa.push({
                    id: item.id,
                    coordinates: item.coordinates, // 多边形坐标数组
                    color: item.color,
                    height: item.height, // 3D多边形的高度
                    ...option
                })
            }
        })

        await that.add(curOa)
        resolve({ success: 1 })
    })
}

/**
 * 取消分析
 */
AnalyseBIZ.prototype.cancel_biz = function (apiOBJ) {
    let that = this
    return new Promise(async (resolve, reject) => {
        let __apiOBJ = apiOBJ || window.sealAPI
        __apiOBJ._editHelper.cancel()

        await __apiOBJ._polyline.delete_biz(that.redLineData.data, apiOBJ)

        let p3did = []
        p3did.push(...that.heightControlData.data.map(item => item.id))
        p3did.push(...that.heightControlData.data.filter(item => item.top > 0).map(item => item.id + 1))
        await that.delete(p3did)
        await that.delete(that.greenData.data.map(item => item.id))
        resolve({ success: 1 })
    })
}

AnalyseBIZ.prototype.clear_biz = function (apiOBJ) {
    let that = this
    return new Promise(async (resolve, reject) => {
        await that.cancel_biz(apiOBJ)
        resolve()
    })
}

export default AnalyseBIZ